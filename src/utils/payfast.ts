import CryptoJS from 'crypto-js';

export interface PayFastData {
  merchant_id: string;
  merchant_key: string;
  return_url: string;
  cancel_url: string;
  notify_url: string;
  name_first?: string;
  name_last?: string;
  email_address?: string;
  cell_number?: string;
  m_payment_id?: string;
  amount: string;
  item_name: string;
  item_description?: string;
  email_confirmation?: '1' | '0';
  confirmation_address?: string;
  payment_method?: string;
}

/**
 * Generate PayFast signature exactly as PayFast expects
 * This follows the official PayFast documentation
 */
export const generatePayFastSignature = (data: PayFastData, passphrase: string): string => {
  // Create an array to hold all parameter strings
  const paramStrings: string[] = [];
  
  // Get all keys and sort them alphabetically (THIS IS CRITICAL)
  const sortedKeys = Object.keys(data).sort() as Array<keyof PayFastData>;
  
  // Build each parameter string
  for (const key of sortedKeys) {
    const value = data[key];
    // Skip undefined, null, or empty values
    if (value === undefined || value === null || value === '') {
      continue;
    }
    
    // Convert to string and trim
    const stringValue = value.toString().trim();
    
    // URL encode the value - PayFast uses a specific encoding
    // This matches PayFast's quote_plus encoding
    const encodedValue = encodeURIComponent(stringValue)
      .replace(/%20/g, '+')   // Replace %20 with + for spaces
      .replace(/!/g, '%21')
      .replace(/'/g, '%27')
      .replace(/\(/g, '%28')
      .replace(/\)/g, '%29')
      .replace(/\*/g, '%2A');
    
    paramStrings.push(`${key}=${encodedValue}`);
  }
  
  // Add the passphrase (DO NOT ENCODE THE PASSPHRASE)
  paramStrings.push(`passphrase=${passphrase}`);
  
  // Join with & to create the final string
  const signatureString = paramStrings.join('&');
  
  // Log for debugging (remove in production)
  console.log('ðŸ“ Signature String:', signatureString);
  
  // Generate MD5 hash
  const signature = CryptoJS.MD5(signatureString).toString();
  console.log('âœ… Signature:', signature);
  
  return signature;
};

export const PAYFAST_URLS = {
  sandbox: 'https://sandbox.payfast.co.za/eng/process',
  live: 'https://www.payfast.co.za/eng/process'
};

export const generatePaymentId = (): string => {
  return `PAY-${Date.now()}-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
};